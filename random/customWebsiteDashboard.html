<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Website Dashboard</title>
  <!-- Include Gridstack CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.3.0/gridstack.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #000000;
    }
    .controls {
      margin: 10px;
    }
    /* Style for each panel content */
    .grid-stack-item-content {
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    /* Panel header for dragging and title display */
    .panel-header {
      background: #eee;
      padding: 5px;
      cursor: move;
      font-weight: bold;
      position: relative;
    }
    /* Button in header to remove panel */
    .panel-header button {
      float: right;
      background: transparent;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    /* Panel content area for the iframe */
    .panel-content {
      width: 100%;
      height: calc(100% - 30px); /* Adjust if header height changes */
      position: relative;
    }
    /* Error message overlay styling */
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: red;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      display: none;
      z-index: 10;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <!-- Control Buttons -->
  <div class="controls">
    <button id="addPanel">Add Panel</button>
    <button id="saveLayout">Save Layout</button>
    <button id="loadLayout">Load Layout</button>
  </div>
  
  <!-- Gridstack Container -->
  <div class="grid-stack"></div>

  <!-- Include Gridstack JavaScript (which includes dependency management) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.3.0/gridstack-all.js"></script>
  <script>
    // Initialize Gridstack with a fixed cell height
    const grid = GridStack.init({
      cellHeight: 100,
      disableOneColumnMode: true
    });

    // Maintain a counter for unique panel IDs
    let panelCount = 0;

    /**
     * addNewPanel(url, x, y, width, height)
     * Creates a new panel with a unique id, embeds an iframe with the provided URL,
     * and sets its grid position/dimensions. It also attaches error handling.
     */
    function addNewPanel(url = "https://example.com", x = 0, y = 0, width = 4, height = 2) {
      panelCount++;
      const panelId = "panel-" + panelCount;

      // Create the main panel element with Gridstack's required class and attributes
      const panelEl = document.createElement('div');
      panelEl.className = 'grid-stack-item';
      panelEl.setAttribute('data-gs-x', x);
      panelEl.setAttribute('data-gs-y', y);
      panelEl.setAttribute('data-gs-width', width);
      panelEl.setAttribute('data-gs-height', height);
      panelEl.id = panelId;

      // Create an inner container for panel content
      const innerEl = document.createElement('div');
      innerEl.className = 'grid-stack-item-content';

      // Create a header element that shows the URL and provides a remove button
      const headerEl = document.createElement('div');
      headerEl.className = 'panel-header';
      headerEl.textContent = url;

      // Remove panel button
      const removeBtn = document.createElement('button');
      removeBtn.textContent = "X";
      removeBtn.title = "Remove Panel";
      removeBtn.onclick = function(e) {
        e.stopPropagation();
        grid.removeWidget(panelEl);
      };
      headerEl.appendChild(removeBtn);

      // Create content area to hold the iframe and error message
      const contentEl = document.createElement('div');
      contentEl.className = 'panel-content';

      // Error message overlay (hidden by default)
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = "Failed to load website.";
      contentEl.appendChild(errorDiv);

      // Create the iframe element
      const iframe = document.createElement('iframe');
      iframe.src = url;
      contentEl.appendChild(iframe);

      // Assemble the panel
      innerEl.appendChild(headerEl);
      innerEl.appendChild(contentEl);
      panelEl.appendChild(innerEl);

      // Add the panel to Gridstack
      grid.addWidget(panelEl);

      // --- Error Handling for the iframe ---
      // Use a timeout to detect load failure (e.g., 10 seconds)
      let loaded = false;
      const timeoutDuration = 10000; // milliseconds
      const timer = setTimeout(() => {
        if (!loaded) {
          errorDiv.style.display = "block";
          iframe.style.display = "none";
        }
      }, timeoutDuration);

      // When the iframe loads successfully, clear the timer and hide error overlay
      iframe.addEventListener("load", () => {
        loaded = true;
        clearTimeout(timer);
        errorDiv.style.display = "none";
        iframe.style.display = "block";
      });
    }

    // Event listener for "Add Panel" button: prompts user for a URL
    document.getElementById("addPanel").addEventListener("click", () => {
      const url = prompt("Enter website URL:", "https://example.com");
      if (url) {
        addNewPanel(url);
      }
    });

    // Save the current layout into localStorage
    document.getElementById("saveLayout").addEventListener("click", () => {
      const serializedData = [];
      // Gridstack's engine.nodes array contains the layout information for each widget
      grid.engine.nodes.forEach((node) => {
        const el = node.el;
        const iframe = el.querySelector("iframe");
        const url = iframe ? iframe.src : "";
        serializedData.push({
          id: el.id,
          x: node.x,
          y: node.y,
          width: node.width,
          height: node.height,
          url: url
        });
      });
      localStorage.setItem("gridLayout", JSON.stringify(serializedData));
      alert("Layout saved!");
    });

    // Load the layout from localStorage, clearing existing panels first
    document.getElementById("loadLayout").addEventListener("click", () => {
      const layout = localStorage.getItem("gridLayout");
      if (layout) {
        // Remove all existing widgets
        grid.removeAll();
        const panels = JSON.parse(layout);
        panels.forEach((panel) => {
          // Adjust panelCount if needed to maintain unique IDs
          const idNum = parseInt(panel.id.split("-")[1]);
          if (idNum > panelCount) panelCount = idNum;
          addNewPanel(panel.url, panel.x, panel.y, panel.width, panel.height);
        });
        alert("Layout loaded!");
      } else {
        alert("No saved layout found!");
      }
    });

    // Create an initial panel as a starting point
    addNewPanel("https://example.com");
  </script>
</body>
</html>
